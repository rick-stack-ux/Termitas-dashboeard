<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Sonda 1</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

<style>
:root{
  --bg:#0f1720;
  --card:#0f1725;
  --text:#e6eef6;
  --muted:#9aa9bd;
  --accent:#00c8ff;
  --danger:#ff3b3b;
  --shadow: 0 8px 20px rgba(2,8,23,0.6);
}
body.light{
  --bg:#f3f6fb;
  --card:#ffffff;
  --text:#1b2330;
  --muted:#556575;
  --accent:#007BFF;
  --danger:#ff3b3b;
  --shadow: 0 6px 18px rgba(16,24,40,0.08);
}
html,body{height:100%;margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
.app{max-width:600px;margin:18px auto;padding:14px;}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;}
.title h1{margin:0;font-size:20px;letter-spacing:0.2px}
.title p{margin:0;color:var(--muted);font-size:13px}
.controls{display:flex;gap:10px;align-items:center;}
.mode-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;}
.summary{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap;}
.metric{background:var(--card);padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);min-width:140px;text-align:center;}
.metric small{display:block;color:var(--muted);font-size:12px}
.metric b{display:block;font-size:18px;margin-top:6px}
.grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));gap:16px;}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);position:relative;transition: box-shadow .25s ease, transform .18s ease, border-color .15s ease;border: 2px solid transparent;overflow:hidden;}
.card:hover{ transform: translateY(-6px); }
.card.alert { border-color: var(--danger); box-shadow: 0 12px 30px rgba(255,50,50,0.12);}
.card .sonda-title{ font-weight:600; font-size:15px; margin-bottom:8px; color:var(--text) }
.tog { font-size:13px; color:var(--muted); display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.charts{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; padding:6px 0; }
canvas { width:110px !important; height:110px !important; }
.labels { display:flex; gap:10px; justify-content:center; margin-top:6px; flex-wrap:wrap; }
.lbl { font-size:12px; color:var(--muted); text-align:center; min-width:95px; }
.val { font-weight:700; color:var(--text); margin-top:4px; font-size:14px }
.card.inactive{ opacity:.35; filter:grayscale(.1); }
.note{ margin-top:12px;color:var(--muted);font-size:13px; text-align:center }
.presenciaAlert{ font-weight:700;text-align:center;padding:8px 6px;margin-top:8px;border-radius:8px;background: rgba(255,0,0,0.04);color: #ff8a8a;min-height:44px;display:flex;flex-direction:column;justify-content:center; }
.presenciaAlert b{ color:var(--danger); }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <h1>Panel Sonda 1</h1>
      <p>Monitoreo: Temperatura · Humedad · Distancia (mm)</p>
    </div>
    <div class="controls">
      <button id="modeToggle" class="mode-btn">Modo claro / oscuro</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="metric"><small>Sondas activas</small><b id="numActivas">0</b></div>
    <div class="metric"><small>Alertas distancia</small><b id="numAlertas">0</b></div>
    <div class="metric"><small>Temp. promedio</small><b id="promTemp">-- °C</b></div>
    <div class="metric"><small>Humedad promedio</small><b id="promHum">-- %</b></div>
  </div>

  <!-- Grid -->
  <div class="grid" id="grid"></div>
  <div class="note">Umbral alerta distancia: <b> > 40 mm </b></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
/* CONFIG */
const DIST_THRESHOLD_MM = 40;
const chartsT = [];
const chartsH = [];
const active = [false]; // Sonda 1, estado persistente
let lastValues = [{}];
let badCount = [0];

/* Colors */
function tempColor(v){ if(v<=25) return '#2ecc71'; if(v<=30) return '#f1c40f'; return '#e74c3c'; }
function humColor(){ return '#00c8ff'; }
function formatDateShort(d){ return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

/* Create card for sonda 1 */
function createCard(){
  const grid = document.getElementById('grid');
  const card = document.createElement('div');
  card.className='card';
  card.id='card-1';
  card.innerHTML=`
    <div class="sonda-title">Sonda 1</div>
    <div class="tog">
      <label><input type="checkbox" id="toggle-1"> Activar</label>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:var(--muted)">Dist: <span id="dist-1">--</span> mm</div>
    </div>
    <div class="charts">
      <canvas id="t-1"></canvas>
      <canvas id="h-1"></canvas>
    </div>
    <div class="labels">
      <div class="lbl"><div class="muted">Temperatura</div><div class="val" id="tempVal-1">-- °C</div></div>
      <div class="lbl"><div class="muted">Humedad</div><div class="val" id="humVal-1">-- %</div></div>
    </div>
    <div class="presenciaAlert" id="pres-1"></div>
  `;
  grid.appendChild(card);

  const toggle = document.getElementById('toggle-1');
  // Restaurar estado persistente
  const saved = localStorage.getItem('sonda-1');
  if(saved==='1'){ toggle.checked=true; active[0]=true; } 
  toggle.addEventListener('change',(ev)=>{
    active[0] = ev.target.checked;
    card.classList.toggle('inactive',!active[0]);
    localStorage.setItem('sonda-1', active[0]?'1':'0');
  });

  // Charts
  const ctxT = document.getElementById('t-1').getContext('2d');
  const ctxH = document.getElementById('h-1').getContext('2d');
  chartsT[0] = new Chart(ctxT,{type:'doughnut',data:{datasets:[{data:[0,50],backgroundColor:[tempColor(0),'#2b3944'],borderWidth:0}]} ,options:{rotation:-90,circumference:180,cutout:'72%',plugins:{legend:{display:false},tooltip:{enabled:false}}}});
  chartsH[0] = new Chart(ctxH,{type:'doughnut',data:{datasets:[{data:[0,100],backgroundColor:[humColor(),'#2b3944'],borderWidth:0}]} ,options:{rotation:-90,circumference:180,cutout:'72%',plugins:{legend:{display:false},tooltip:{enabled:false}}}});
}
createCard();

/* Summary update */
function updateSummary(){
  const act = active[0]?1:0;
  const v = lastValues[0]||{};
  const alerts = (v.dist>DIST_THRESHOLD_MM && active[0])?1:0;
  document.getElementById('numActivas').textContent=act;
  document.getElementById('numAlertas').textContent=alerts;
  document.getElementById('promTemp').textContent = (v.t||'--')+' °C';
  document.getElementById('promHum').textContent = (v.h||'--')+' %';
}

/* Distance alert */
function applyDistanceAlert(dist){
  const card = document.getElementById('card-1');
  const presBox = document.getElementById('pres-1');
  if(dist>DIST_THRESHOLD_MM){ badCount[0]++; } else { badCount[0]=0; }
  if(badCount[0]>=4){
    card.classList.add('alert');
    presBox.innerHTML=`<div style="font-size:13px"><b>PRESENCIA DETECTADA</b></div><div style="font-size:12px;color:var(--muted)">${formatDateShort(new Date())}</div><div style="font-size:13px">Dist: ${dist} mm</div>`;
  } else {
    card.classList.remove('alert'); presBox.innerHTML='';
  }
}

/* Firebase setup */
const firebaseConfig = { databaseURL:"https://enlace-t-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
db.ref("prueba").on("value",(snap)=>{
  const data = snap.val(); if(!data) return;
  if(!active[0]) return;
  const t = Number(data.Temperatura_C||0);
  const h = Number(data.Humedad_pct||0);
  const d = Number(data.Distancia_mm||0);
  lastValues[0] = {t,h,dist:d};
  document.getElementById('tempVal-1').textContent=t+' °C';
  document.getElementById('humVal-1').textContent=h+' %';
  document.getElementById('dist-1').textContent=d+' mm';
  chartsT[0].data.datasets[0].data[0]=t; chartsT[0].data.datasets[0].backgroundColor[0]=tempColor(t); chartsT[0].update();
  chartsH[0].data.datasets[0].data[0]=h; chartsH[0].data.datasets[0].backgroundColor[0]=humColor(); chartsH[0].update();
  applyDistanceAlert(d);
  updateSummary();
});

/* Mode toggle */
document.getElementById('modeToggle').addEventListener('click',()=>{ document.body.classList.toggle('light'); });
</script>
</body>
</html>
