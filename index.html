<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Sondas T</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{ --bg:#0f1720; --card:#0f1725; --text:#e6eef6; --muted:#9aa9bd; --accent:#00c8ff; --danger:#ff3b3b; --shadow:0 8px 20px rgba(2,8,23,0.6); }
body.light{ --bg:#f3f6fb; --card:#ffffff; --text:#1b2330; --muted:#556575; --accent:#007BFF; --danger:#ff3b3b; --shadow:0 6px 18px rgba(16,24,40,0.08); }

html,body{
  margin:0;
  padding:0;
  font-family:Inter,system-ui,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
  height:100%;
}

.app{max-width:1200px;margin:18px auto;padding:14px;}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;}
.title h1{margin:0;font-size:20px;}
.title p{margin:0;color:var(--muted);font-size:13px;}

.controls{display:flex;gap:10px;align-items:center;}
.mode-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;}

.summary{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap;}
.metric{background:var(--card);padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);min-width:140px;text-align:center;}
.metric small{display:block;color:var(--muted);font-size:12px;}
.metric b{display:block;font-size:18px;margin-top:6px;}

.grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));gap:16px;}

.card{
  background:var(--card);
  border-radius:12px;
  padding:14px;
  box-shadow:var(--shadow);
  position:relative;
  transition: box-shadow .25s ease, transform .18s ease, border-color .15s ease;
  border: 2px solid transparent;
  overflow:hidden;
}

.card.alert{
  border-color: var(--danger);
  box-shadow:0 12px 30px rgba(255,50,50,0.12);
}

.card .sonda-title{
  font-weight:600;
  font-size:15px;
  margin-bottom:8px;
}

.tog{
  font-size:13px;
  color:var(--muted);
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:8px;
}

.charts{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; padding:6px 0; }
canvas{ width:110px !important; height:110px !important; }

.labels{ display:flex; gap:10px; justify-content:center; margin-top:6px; flex-wrap:wrap; }
.lbl{ font-size:12px; color:var(--muted); text-align:center; min-width:95px; }
.val{ font-weight:700; color:var(--text); margin-top:4px; font-size:14px; }

.card.inactive{ opacity:.35; filter:grayscale(.1); }

.note{ margin-top:12px;color:var(--muted);font-size:13px; text-align:center; }

.presenciaAlert{
  font-weight:700;
  text-align:center;
  padding:8px 6px;
  margin-top:8px;
  border-radius:8px;
  background: transparent;  
  color: var(--danger);
  min-height:44px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  transition: background 0.25s ease;
}

.card.alert .presenciaAlert{
  background: rgba(255,0,0,.12);
  border:1px solid rgba(255,0,0,.18);
  color: var(--danger);
}
</style>
</head>

<body>
<div class="app">
  <h1>Panel Sondas T</h1>
  <div id="grid"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ==========================================================
   ⚠️ CONFIGURACIÓN LÓGICA DE ALARMA POR DISTANCIA
   ----------------------------------------------------------
   lecturasFueraRangoNecesarias:
   → Cantidad de lecturas CONSECUTIVAS fuera del umbral
   → necesarias para activar la alarma de presencia

   EJEMPLOS:
   1  = muy sensible (puede dar falsos positivos)
   2  = recomendado ✅
   3+ = más estricto
   ========================================================== */
const lecturasFueraRangoNecesarias = 2;
/* ========================================================== */

const NUM = 5;
const DIST_THRESHOLD_MM = 50;

const badCount = Array(NUM).fill(0);
const active = [true,false,false,false,false];

function formatDateShort(d){
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
}

function createCard(i){
  const card=document.createElement('div');
  card.className='card';
  card.id=`card-${i}`;

  card.innerHTML=`
    <h3>Sonda ${i+1}</h3>
    <div>Distancia: <span id="dist-${i}">--</span> mm</div>
    <div class="presenciaAlert" id="pres-${i}"></div>
  `;
  document.getElementById('grid').appendChild(card);
}

function applyDistanceAlert(i, dist){
  if(dist > DIST_THRESHOLD_MM){
    badCount[i]++;
  } else {
    badCount[i] = 0;
  }

  if(badCount[i] >= lecturasFueraRangoNecesarias){
    activarPresencia(i, dist);
  } else {
    quitarPresencia(i);
  }
}

function activarPresencia(i, dist){
  const card=document.getElementById(`card-${i}`);
  card.classList.add('alert');
  document.getElementById(`pres-${i}`).innerHTML = `
    PRESENCIA DETECTADA<br>
    ${formatDateShort(new Date())}<br>
    Dist: ${Math.round(dist)} mm
  `;
}

function quitarPresencia(i){
  const card=document.getElementById(`card-${i}`);
  card.classList.remove('alert');
  document.getElementById(`pres-${i}`).innerHTML = '';
}

for(let i=0;i<NUM;i++) createCard(i);

const firebaseConfig={ databaseURL:"https://enlace-t-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

db.ref("prueba").on("value", snap=>{
  const d = Number(snap.val()?.Distancia_mm ?? 0);
  document.getElementById("dist-0").textContent = d;
  applyDistanceAlert(0, d);
});
</script>
</body>
</html>
