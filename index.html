<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Dashboard Termitas</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  background-color: #dcdcdc;
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
}
h1 { text-align:center; color:#333; margin-bottom:30px; }

.bloque {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 20px;
  margin-bottom: 30px;
}

.sonda {
  background-color:#fff;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  padding:15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  transition: transform 0.3s, border 0.3s;
  cursor:pointer;
}

.sonda:hover { transform: translateY(-5px); }
.sonda.seleccionada { border: 3px solid #007bff; }

.sonda h2 { margin:0; font-size:1.1em; color:#555; margin-bottom:10px; text-align:center; }
canvas { width: 80px !important; height: 80px !important; margin-bottom:5px; }
.valor {
  font-size: 0.9em;
  font-weight: bold;
  color: #333;
  text-align:center;
  margin-bottom:5px;
}
.alerta {
  background-color:#ff4d4d;
  color:#fff;
  font-weight:bold;
  padding:5px 10px;
  border-radius:8px;
  display:none;
  text-align:center;
  width:100%;
  margin-top:5px;
}
</style>
</head>
<body>

<h1>Dashboard Termitas</h1>
<div id="bloques-container"></div>

<script>
const totalSondas = 20;
const sondasPorBloque = 5;
const bloquesContainer = document.getElementById('bloques-container');
const chartsTemp = [];
const chartsHum = [];
let sondaSeleccionada = null;

// Valores de prueba si data.json no existe
const valoresPrueba = Array.from({length: totalSondas}, (_, i) => ({
  Temperatura_C: Math.floor(Math.random()*10+20), // 20-29°C
  Humedad_pct: Math.floor(Math.random()*30+40),   // 40-70%
  Distancia_mm: Math.floor(Math.random()*20+25)   // 25-44 mm
}));

// Crear bloques
for(let b=0; b<totalSondas/sondasPorBloque; b++){
  const bloqueDiv = document.createElement('div');
  bloqueDiv.classList.add('bloque');

  for(let i=1; i<=sondasPorBloque; i++){
    const sondaIndex = b*sondasPorBloque + i;
    const sondaDiv = document.createElement('div');
    sondaDiv.classList.add('sonda');
    sondaDiv.id = `sonda-${sondaIndex}`;
    sondaDiv.innerHTML = `
      <h2>Sonda ${sondaIndex}</h2>
      <canvas id="tempChart-${sondaIndex}"></canvas>
      <div class="valor" id="valorTemp-${sondaIndex}">${valoresPrueba[sondaIndex-1].Temperatura_C}°C</div>
      <canvas id="humChart-${sondaIndex}"></canvas>
      <div class="valor" id="valorHum-${sondaIndex}">${valoresPrueba[sondaIndex-1].Humedad_pct}%</div>
      <div class="alerta" id="alerta-${sondaIndex}" style="display:${valoresPrueba[sondaIndex-1].Distancia_mm>30?'block':'none'}">
        ¡Alerta de termitas!
      </div>
    `;
    // Selección de bloque
    sondaDiv.addEventListener('click', ()=>{
      if(sondaSeleccionada) sondaSeleccionada.classList.remove('seleccionada');
      sondaDiv.classList.add('seleccionada');
      sondaSeleccionada = sondaDiv;
    });
    bloqueDiv.appendChild(sondaDiv);

    // Gráfico Temperatura: degradado verde→amarillo→rojo
    const ctxTemp = document.getElementById(`tempChart-${sondaIndex}`).getContext('2d');
    const gradTemp = ctxTemp.createLinearGradient(0,0,0,80);
    gradTemp.addColorStop(0,'#00ff00');
    gradTemp.addColorStop(0.5,'#ffff00');
    gradTemp.addColorStop(1,'#ff0000');
    const tempChart = new Chart(ctxTemp,{
      type:'doughnut',
      data:{
        labels:['Temp','Resto'],
        datasets:[{data:[valoresPrueba[sondaIndex-1].Temperatura_C,50], backgroundColor:[gradTemp,'#eee'], borderWidth:0}]
      },
      options:{cutout:'70%', plugins:{legend:{display:false}}, rotation:-90, circumference:180}
    });
    chartsTemp.push(tempChart);

    // Gráfico Humedad celeste
    const ctxHum = document.getElementById(`humChart-${sondaIndex}`).getContext('2d');
    const humChart = new Chart(ctxHum,{
      type:'doughnut',
      data:{
        labels:['Hum','Resto'],
        datasets:[{data:[valoresPrueba[sondaIndex-1].Humedad_pct,100-valoresPrueba[sondaIndex-1].Humedad_pct], backgroundColor:['#36cce7','#eee'], borderWidth:0}]
      },
      options:{cutout:'70%', plugins:{legend:{display:false}}, rotation:-90, circumference:180}
    });
    chartsHum.push(humChart);
  }
  bloquesContainer.appendChild(bloqueDiv);
}

// Función de actualización
async function actualizarDatos(){
  try{
    const response = await fetch('data/data.json');
    const data = await response.json();
    if(!data.sondas) return;

    data.sondas.forEach((sonda,index)=>{
      if(!sonda) return;
      const temp = sonda.Temperatura_C ?? valoresPrueba[index].Temperatura_C;
      const hum = sonda.Humedad_pct ?? valoresPrueba[index].Humedad_pct;
      const dist = sonda.Distancia_mm ?? valoresPrueba[index].Distancia_mm;

      chartsTemp[index].data.datasets[0].data[0] = temp;
      chartsTemp[index].update();
      document.getElementById(`valorTemp-${index+1}`).innerText = temp+'°C';

      chartsHum[index].data.datasets[0].data[0] = hum;
      chartsHum[index].update();
      document.getElementById(`valorHum-${index+1}`).innerText = hum+'%';

      const alertaDiv = document.getElementById(`alerta-${index+1}`);
      alertaDiv.style.display = dist>30?'block':'none';
    });
  }catch(e){ 
    console.warn('No se pudo leer data.json, usando valores de prueba'); 
  }
}

// Actualiza cada 10s
setInterval(actualizarDatos,10000);
</script>

</body>
</html>
