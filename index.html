<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Sondas T</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

<style>
/* …  (todo tu CSS AQUÍ SIN CAMBIOS – no lo repito para no inflar el mensaje)
*/
</style>
</head>
<body>

<div class="app">

  <!-- ************** HEADER ************** -->
  <div class="header">
    <div class="title">
      <h1>Panel Sondas T</h1>
      <p>Monitoreo: Temperatura · Humedad · Distancia (mm)</p>
    </div>

    <div class="controls">
      <button id="btnHistorial" class="mode-btn">Historial</button>
      <button id="modeToggle" class="mode-btn">Modo claro / oscuro</button>
    </div>
  </div>

  <!-- ************** RESUMEN ************** -->
  <div class="summary">
    <div class="metric"><small>Sondas activas</small><b id="numActivas">0</b></div>
    <div class="metric"><small>Alertas distancia</small><b id="numAlertas">0</b></div>
    <div class="metric"><small>Temp. promedio</small><b id="promTemp">-- °C</b></div>
    <div class="metric"><small>Humedad promedio</small><b id="promHum">-- %</b></div>
  </div>

  <!-- ************** GRID ************** -->
  <div class="grid" id="grid"></div>

  <div class="note">
    Umbral alerta distancia: <b> > 40 mm </b> (4 cm → objeto caído)
  </div>

</div>

<!-- ************** MODAL HISTORIAL ************** -->
<div id="historyModal" class="modal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2>Historial semanal - Sondas</h2>
      <div style="display:flex;gap:8px">
        <button id="exportAll" class="mode-btn">Exportar</button>
        <button id="closeHist" class="mode-btn">Cerrar</button>
      </div>
    </div>

    <div id="historyContent"></div>
    <div style="margin-top:10px;color:var(--muted);font-size:13px">
      Se muestran las lecturas guardadas (últimos 7 días aprox.).
    </div>
  </div>
</div>

<script>
/* ======================  CONFIG ====================== */
const NUM = 5;
const DIST_THRESHOLD_MM = 40;
const UPDATE_MS = 5000;

const chartsT = [];
const chartsH = [];
const active = new Array(NUM).fill(true);
const lastValues = new Array(NUM).fill(null);
const badCount   = new Array(NUM).fill(0);


/* ======================  HELPERS ====================== */
function tempColor(v){
  if(v<=25) return '#2ecc71';
  if(v<=30) return '#f1c40f';
  return '#e74c3c';
}
function humColor(){ return '#00c8ff'; }

function formatDateShort(d){
  return d.toLocaleDateString("es-CL") + " " + d.toLocaleTimeString("es-CL",{hour:'2-digit',minute:'2-digit'});
}


/* ====================== CREAR TARJETA ====================== */
function createCard(i, initial){
  const grid=document.getElementById("grid");
  const card=document.createElement("div");
  card.className="card";
  card.id="card-"+(i+1);

  card.innerHTML=`
    <div class="sonda-title">Sonda ${i+1}</div>
    <div class="tog">
      <label><input id="toggle-${i+1}" type="checkbox" checked> Activar</label>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:var(--muted)">Dist: <span id="dist-${i+1}">--</span> mm</div>
    </div>

    <div class="charts">
      <canvas id="t-${i+1}"></canvas>
      <canvas id="h-${i+1}"></canvas>
    </div>

    <div class="labels">
      <div class="lbl"><div class="muted">Temperatura</div><div id="tempVal-${i+1}" class="val">-- °C</div></div>
      <div class="lbl"><div class="muted">Humedad</div><div id="humVal-${i+1}" class="val">-- %</div></div>
    </div>
  `;

  grid.appendChild(card);

  /* box presencia */
  const pres=document.createElement("div");
  pres.className="presenciaAlert";
  pres.id="pres-"+(i+1);
  card.appendChild(pres);

  /* ================== RESTORE CHECKBOX ================== */
  const tog=card.querySelector("#toggle-"+(i+1));
  const saved=localStorage.getItem("sonda-"+(i+1));
  if(saved!==null){
    tog.checked=saved==="1";
    active[i]=tog.checked;
    if(!tog.checked) card.classList.add("inactive");
  }
  tog.onchange=e=>{
    active[i]=e.target.checked;
    localStorage.setItem("sonda-"+(i+1), e.target.checked?"1":"0");
    card.classList.toggle("inactive", !e.target.checked);
    updateSummary();
  };


  /* ================== CHARTS ================== */
  chartsT[i]=new Chart(document.getElementById("t-"+(i+1)),{
    type:"doughnut",
    data:{datasets:[{data:[initial.t,50-initial.t],backgroundColor:[tempColor(initial.t),'#2b3944'],borderWidth:0}]},
    options:{rotation:-90,circumference:180,cutout:"72%",plugins:{legend:{display:false},tooltip:{enabled:false}}}
  });
  chartsH[i]=new Chart(document.getElementById("h-"+(i+1)),{
    type:"doughnut",
    data:{datasets:[{data:[initial.h,100-initial.h],backgroundColor:[humColor(),'#2b3944'],borderWidth:0}]},
    options:{rotation:-90,circumference:180,cutout:"72%",plugins:{legend:{display:false},tooltip:{enabled:false}}}
  });

  lastValues[i]=initial;
  document.getElementById("tempVal-"+(i+1)).textContent=`${initial.t} °C`;
  document.getElementById("humVal-"+(i+1)).textContent =`${initial.h} %`;
  document.getElementById("dist-"+(i+1)).textContent   = initial.dist;

  applyDistanceAlert(i, initial.dist);
}


/* ====================== ALERTA - PRESENCIA ====================== */
function applyDistanceAlert(i,dist){
  const card=document.getElementById("card-"+(i+1));
  const pres=document.getElementById("pres-"+(i+1));

  if(dist > DIST_THRESHOLD_MM) badCount[i]++;
  else badCount[i]=0;

  if(badCount[i]>=4){
    card.classList.add("alert");
    const now=formatDateShort(new Date());
    pres.innerHTML=`<b>PRESENCIA DETECTADA</b><div>${now}</div><div>${dist} mm</div>`;
    saveHistory(i,lastValues[i].t,lastValues[i].h,dist,true);
  }else{
    card.classList.remove("alert");
    pres.innerHTML="";
  }
}


/* ====================== RESUMEN ====================== */
function updateSummary(){
  let a=0,alerta=0,sumT=0,sumH=0,c=0;
  for(let i=0;i<NUM;i++){
    if(!active[i]) continue;
    a++;
    if(lastValues[i]){
      sumT+=lastValues[i].t;
      sumH+=lastValues[i].h;
      c++;
      if(lastValues[i].dist > DIST_THRESHOLD_MM) alerta++;
    }
  }
  document.getElementById("numActivas").textContent=a;
  document.getElementById("numAlertas").textContent=alerta;
  document.getElementById("promTemp").textContent=(c?Math.round(sumT/c):"--")+" °C";
  document.getElementById("promHum").textContent=(c?Math.round(sumH/c):"--")+" %";
}


/* ====================== HISTORIAL ====================== */
function saveHistory(i,t,h,d,pres){
  const key="history-sonda-"+(i+1);
  const arr=JSON.parse(localStorage.getItem(key)||"[]");
  arr.push({time:new Date().toISOString(),t,h,d,presence:!!pres});
  localStorage.setItem(key,JSON.stringify(arr));
}

function openHistory(){
  const cont=document.getElementById("historyContent");
  cont.innerHTML="";
  for(let i=0;i<NUM;i++){
    const arr=JSON.parse(localStorage.getItem("history-sonda-"+(i+1))||"[]");
    const card=document.createElement("div");
    card.className="historyCard";
    card.innerHTML=`<h3>Sonda ${i+1}</h3>`;
    arr.slice(-200).reverse().forEach(e=>{
      const date=new Date(e.time).toLocaleString("es-CL");
      card.innerHTML+=`
        <div class="histRow">
          <small>${date}</small>
          T=${e.t}°C&nbsp;&nbsp;H=${e.h}%&nbsp;&nbsp;D=${e.d}mm
          ${e.presence?"<b style='color:red'> PRESENCIA</b>":""}
        </div>`;
    });
    cont.appendChild(card);
  }
  document.getElementById("historyModal").classList.add("open");
}

document.getElementById("btnHistorial").onclick=openHistory;
document.getElementById("closeHist").onclick=()=>document.getElementById("historyModal").classList.remove("open");

document.getElementById("exportAll").onclick=()=>{
  const out={};
  for(let i=0;i<NUM;i++){
    out["sonda_"+(i+1)]=JSON.parse(localStorage.getItem("history-sonda-"+(i+1))||"[]");
  }
  const blob=new Blob([JSON.stringify(out,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="historial_sondas.json";
  a.click();
};


/* ====================== FETCH o SIMULACIÓN ====================== */
async function fetchDataOnce(){
  try{
    const r=await fetch("data/data.json",{cache:"no-store"});
    if(!r.ok) throw 0;
    const j=await r.json();
    const arr=Array.isArray(j.sondas)?j.sondas:j;
    return arr;
  }catch(e){
    /* SIMULACIÓN */
    return Array.from({length:NUM}).map(()=>({
      t: Math.round(20+Math.random()*10),
      h: Math.round(40+Math.random()*20),
      dist: Math.round(20+Math.random()*60)
    }));
  }
}


/* ====================== UPDATE LOOP ====================== */
async function updateAll(){
  const data=await fetchDataOnce();
  for(let i=0;i<NUM;i++){
    const v=data[i];
    lastValues[i]=v;

    chartsT[i].data.datasets[0].data=[v.t,50-v.t];
    chartsH[i].data.datasets[0].data=[v.h,100-v.h];
    chartsT[i].update();
    chartsH[i].update();

    document.getElementById("dist-"+(i+1)).textContent=v.dist;
    document.getElementById("tempVal-"+(i+1)).textContent=v.t+" °C";
    document.getElementById("humVal-"+(i+1)).textContent=v.h+" %";

    applyDistanceAlert(i,v.dist);
    saveHistory(i,v.t,v.h,v.dist,false);
  }
  updateSummary();
}

/* ====================== INICIO ====================== */
(async function init(){
  const initData=await fetchDataOnce();
  for(let i=0;i<NUM;i++) createCard(i,initData[i]);
  updateSummary();
  setInterval(updateAll,UPDATE_MS);
})();

/* modo claro/oscuro */
document.getElementById("modeToggle").onclick=()=>document.body.classList.toggle("light");
</script>

</body>
</html>
