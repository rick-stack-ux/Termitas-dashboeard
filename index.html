<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel sondas T</title>

<style>
body{
  margin:0;padding:0;
  font-family:Arial;
  background:#121212;
  color:white;
}
.container{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:20px;
  padding:20px;
}
.card{
  width:300px;
  background:#1c1c1c;
  padding:15px;
  border-radius:10px;
  box-shadow:0 0 10px rgba(0,0,0,.5);
  border:4px solid gray;
}
.card.active{
  /* sin animación aquí */
}
.card.presencia{
  border:4px solid red;
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 5px red;}
  50%{box-shadow:0 0 20px red;}
  100%{box-shadow:0 0 5px red;}
}

h2{margin:0 0 10px;}
.chartBox{height:140px;margin-bottom:8px;}

label{font-size:.9rem}

/* texto de alerta */
.alert{
  font-size:1.1rem;
  font-weight:bold;
  color:red;
  text-align:center;
  padding:5px;
}

/* responsive */
@media(max-width:600px){
  .card{width:95%;}
}
</style>
</head>
<body>

<h1 style="text-align:center;">Panel sondas T</h1>
<div style="text-align:center;margin-bottom:10px;">
  <span id="fecha"></span> -
  <span id="hora"></span>
</div>

<div class="container" id="panel">
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/************** CONFIGURACIÓN *****************/

const numSondas = 5;

const limites = {
  okMin: 10,      // mm
  okMax: 30,      // mm dentro normal
  alertaMax: 40,  // >40 caída
};

const sondas = [];

/***************************************************/

function crearCards(){
  const panel=document.getElementById("panel");
  for(let i=1;i<=numSondas;i++){
    panel.innerHTML+=`
    <div class="card" id="card${i}">
      <h2>Sonda ${i}</h2>

      <label>
        <input type="checkbox" id="enable${i}" onchange="guardarEstado(${i})">
        Activar sonda
      </label>

      <div class="chartBox">
        <canvas id="temp${i}"></canvas>
        <div style="font-size:.8rem;text-align:center;">temperatura</div>
      </div>

      <div class="chartBox">
        <canvas id="hum${i}"></canvas>
        <div style="font-size:.8rem;text-align:center;">humedad</div>
      </div>

      <div id="alert${i}" class="alert" style="display:none;">PRESENCIA</div>
    </div>`;
  }
}

/********* guardar activación ************/
function guardarEstado(id){
  localStorage.setItem("sonda"+id, document.getElementById("enable"+id).checked);
}

/********* cargar activación *************/
function cargarEstado(){
  for(let i=1;i<=numSondas;i++){
    const est = localStorage.getItem("sonda"+i)==="true";
    const ch = document.getElementById("enable"+i);
    ch.checked = est;
  }
}

/******************* reloj fijo *******************/
function actualizarReloj(){
  const f = new Date();
  document.getElementById("fecha").textContent = 
     f.toLocaleDateString("es-CL");
  document.getElementById("hora").textContent = 
     f.toLocaleTimeString("es-CL");
}
setInterval(actualizarReloj,1000);

/***************** actualización de sensores ************************/

// ESP32 deberá enviar json así por websocket o HTTP:
// { s1:{temp:22,hum:44,dist:18}, s2:{...}}

function actualizarValores(data){
  for(let i=1;i<=numSondas;i++){
    const ch=document.getElementById("enable"+i);
    if(!ch.checked || !data[`s${i}`]) continue;

    const T = data[`s${i}`].temp;
    const H = data[`s${i}`].hum;
    const D = data[`s${i}`].dist;

    actualizarChart(i,T,H);

    let card=document.getElementById("card"+i);
    let alertDiv=document.getElementById("alert"+i);

    // lógica distancia
    if(D<limites.okMin || D>limites.alertaMax){
      // presencia CAÍDA
      alertDiv.style.display="block";
      card.classList.add("presencia");
      card.style.borderColor="red";
    }
    else if(D>limites.okMax){
      // advertencia
      alertDiv.style.display="none";
      card.classList.remove("presencia");
      card.style.borderColor="yellow";
    } else {
      // normal
      alertDiv.style.display="none";
      card.classList.remove("presencia");
      card.style.borderColor="lime";
    }
  }
}

/*************** charts ****************/
const charts={};

function initCharts(){
  for(let i=1;i<=numSondas;i++){
    charts["t"+i]=new Chart(
      document.getElementById("temp"+i),
      {
        type:"line",
        data:{labels:[],datasets:[{
          label:"T",
          data:[],
          borderColor:"rgba(0,255,0,.9)",
          tension:.4
        }]}
      }
    );

    charts["h"+i]=new Chart(
      document.getElementById("hum"+i),
      {
        type:"line",
        data:{labels:[],datasets:[{
          label:"H",
          data:[],
          borderColor:"rgba(0,200,255,.9)",
          tension:.4
        }]}
      }
    );
  }
}

function actualizarChart(id,T,H){
  const t=charts["t"+id];
  const h=charts["h"+id];
  const hora=new Date().toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"});

  if(t.data.labels.length>20) t.data.labels.shift();
  if(t.data.datasets[0].data.length>20) t.data.datasets[0].data.shift();
  if(h.data.labels.length>20) h.data.labels.shift();
  if(h.data.datasets[0].data.length>20) h.data.datasets[0].data.shift();

  t.data.labels.push(hora);
  t.data.datasets[0].data.push(T);

  h.data.labels.push(hora);
  h.data.datasets[0].data.push(H);

  t.update();
  h.update();
}

/**************** START *****************/
crearCards();
initCharts();
window.onload=cargarEstado;
actualizarReloj();

/*************************************************
SIMULACIÓN (BORRAR CUANDO LLEGUE ESP32)
*************************************************/
setInterval(()=>{
  const fake={
    s1:{temp:25,hum:60,dist:Math.random()*60},
    s2:{temp:24,hum:55,dist:Math.random()*60},
    s3:{temp:26,hum:62,dist:Math.random()*60},
    s4:{temp:23,hum:58,dist:Math.random()*60},
    s5:{temp:27,hum:63,dist:Math.random()*60},
  };
  actualizarValores(fake);
},3000);
</script>

</body>
</html>
