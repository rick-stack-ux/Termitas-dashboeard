<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panel Sondas T</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{ --bg:#0f1720; --card:#0f1725; --text:#e6eef6; --muted:#9aa9bd; --accent:#00c8ff; --danger:#ff3b3b; --shadow:0 8px 20px rgba(2,8,23,0.6); }
body.light{ --bg:#f3f6fb; --card:#ffffff; --text:#1b2330; --muted:#556575; --accent:#007BFF; --danger:#ff3b3b; --shadow:0 6px 18px rgba(16,24,40,0.08); }
html,body{margin:0;padding:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);height:100%;}
.app{max-width:1200px;margin:18px auto;padding:14px;}
.header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;}
.title h1{margin:0;font-size:20px;} .title p{margin:0;color:var(--muted);font-size:13px;}
.controls{display:flex;gap:10px;align-items:center;}
.mode-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:13px;}
.summary{display:flex;gap:12px;margin-bottom:18px;flex-wrap:wrap;}
.metric{background:var(--card);padding:12px 14px;border-radius:10px;box-shadow:var(--shadow);min-width:140px;text-align:center;}
.metric small{display:block;color:var(--muted);font-size:12px;} .metric b{display:block;font-size:18px;margin-top:6px;}
.grid{display:grid;grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));gap:16px;}
.card{background:var(--card);border-radius:12px;padding:14px;box-shadow:var(--shadow);position:relative;transition: box-shadow .25s ease, transform .18s ease, border-color .15s ease;border: 2px solid transparent;overflow:hidden;}
.card.alert{border-color: var(--danger); box-shadow:0 12px 30px rgba(255,50,50,0.12);}
.card .sonda-title{ font-weight:600; font-size:15px; margin-bottom:8px; }
.tog{ font-size:13px; color:var(--muted); display:flex; gap:8px; align-items:center; margin-bottom:8px; }
.charts{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; padding:6px 0; }
canvas{ width:110px !important; height:110px !important; }
.labels{ display:flex; gap:10px; justify-content:center; margin-top:6px; flex-wrap:wrap; }
.lbl{ font-size:12px; color:var(--muted); text-align:center; min-width:95px; }
.val{ font-weight:700; color:var(--text); margin-top:4px; font-size:14px; }
.card.inactive{ opacity:.35; filter:grayscale(.1); }
.note{ margin-top:12px;color:var(--muted);font-size:13px; text-align:center; }
.presenciaAlert{ font-weight:700; text-align:center; padding:8px 6px; margin-top:8px; border-radius:8px; background: rgba(255,0,0,0.04); color: #ff8a8a; min-height:44px; display:flex; flex-direction:column; justify-content:center; }
.presenciaAlert b{ color:var(--danger); }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <h1>Panel Sondas T</h1>
      <p>Monitoreo: Temperatura · Humedad · Distancia (mm)</p>
    </div>
    <div class="controls">
      <button id="modeToggle" class="mode-btn">Modo claro / oscuro</button>
      <button id="histWeek" class="mode-btn">Última semana</button>
      <button id="histMonth" class="mode-btn">Último mes</button>
    </div>
  </div>

  <div class="summary">
    <div class="metric"><small>Sondas activas</small><b id="numActivas">0</b></div>
    <div class="metric"><small>Alertas distancia</small><b id="numAlertas">0</b></div>
    <div class="metric"><small>Temp. promedio</small><b id="promTemp">-- °C</b></div>
    <div class="metric"><small>Humedad promedio</small><b id="promHum">-- %</b></div>
  </div>

  <div class="grid" id="grid"></div>
  <div class="note">Umbral alerta distancia: <b> > 40 mm </b> (4 cm → objeto caído)</div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const NUM = 5, DIST_THRESHOLD_MM = 40;
const chartsT = [], chartsH = [], active = [true,false,false,false,false], lastValues = Array(NUM).fill(null), badCount = Array(NUM).fill(0);

// colores
function tempColor(v){ return v<=25?'rgba(46,204,113,0.8)':(v<=30?'rgba(241,196,15,0.8)':'rgba(231,76,60,0.8)'); }
function humColor(){ return 'rgba(0,200,255,0.8)'; }
function formatDateShort(d){ return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; }

// crea card por sonda
function createCard(i){
  const grid=document.getElementById('grid');
  const card=document.createElement('div'); card.className='card'; card.id=`card-${i+1}`;
  if(!active[i]) card.classList.add('inactive');
  card.innerHTML=`
    <div class="sonda-title">Sonda ${i+1}</div>
    <div class="tog">
      <label><input type="checkbox" id="toggle-${i+1}" ${active[i]?'checked':''}> Activar</label>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:var(--muted)">Dist: <span id="dist-${i+1}">--</span> mm</div>
    </div>
    <div class="charts">
      <canvas id="t-${i+1}"></canvas>
      <canvas id="h-${i+1}"></canvas>
    </div>
    <div class="labels">
      <div class="lbl"><div class="muted">Temperatura</div><div class="val" id="tempVal-${i+1}">-- °C</div></div>
      <div class="lbl"><div class="muted">Humedad</div><div class="val" id="humVal-${i+1}">-- %</div></div>
    </div>
  `;
  grid.appendChild(card);

  const presencia=document.createElement("div"); presencia.className="presenciaAlert"; presencia.id=`pres-${i+1}`; card.appendChild(presencia);

  const toggle=card.querySelector(`#toggle-${i+1}`);
  toggle.addEventListener('change',(ev)=>{ 
    active[i]=ev.target.checked; 
    card.classList.toggle('inactive',!active[i]); 
    updateSummary(); 
  });

  const ctxT=card.querySelector(`#t-${i+1}`).getContext('2d');
  const ctxH=card.querySelector(`#h-${i+1}`).getContext('2d');
  
  chartsT[i]=new Chart(ctxT,{
    type:'doughnut',
    data:{datasets:[{data:[0,50],backgroundColor:[tempColor(0),'#2b3944'],borderWidth:0}]},
    options:{rotation:-90,circumference:180,cutout:'72%',plugins:{legend:{display:false},tooltip:{enabled:false}},animation:{duration:300}}
  });
  
  chartsH[i]=new Chart(ctxH,{
    type:'doughnut',
    data:{datasets:[{data:[0,100],backgroundColor:[humColor(),'#2b3944'],borderWidth:0}]},
    options:{rotation:-90,circumference:180,cutout:'72%',plugins:{legend:{display:false},tooltip:{enabled:false}},animation:{duration:300}}
  });
}

// resumen de valores
function updateSummary(){
  let act=0, alerts=0, sumT=0, sumH=0, count=0;
  for(let i=0;i<NUM;i++){
    if(!active[i]) continue;
    act++;
    const v=lastValues[i];
    if(!v) continue;
    sumT+=v.t; sumH+=v.h; count++;
    if(v.dist > DIST_THRESHOLD_MM) alerts++;
  }
  document.getElementById('numActivas').textContent=act;
  document.getElementById('numAlertas').textContent=alerts;
  document.getElementById('promTemp').textContent=(count?Math.round(sumT/count):'--')+' °C';
  document.getElementById('promHum').textContent=(count?Math.round(sumH/count):'--')+' %';
}

// alerta presencia
function applyDistanceAlert(i, dist){
  const card=document.getElementById(`card-${i+1}`);
  if(dist > DIST_THRESHOLD_MM) badCount[i]++; else badCount[i]=0;

  if(badCount[i] >= 4) activarPresencia(i, dist);
  else quitarPresencia(i);
}

function activarPresencia(i, dist){
  const card=document.getElementById(`card-${i+1}`); 
  if(!card) return; 
  card.classList.add('alert');
  const box=document.getElementById(`pres-${i+1}`);
  if(box){
    const now=new Date();
    const distMM = Math.round(dist); // asegura mostrar solo mm
    box.innerHTML=`<div style="font-size:13px"><b>PRESENCIA DETECTADA</b></div>
                   <div style="font-size:12px;color:var(--muted)">${formatDateShort(now)}</div>
                   <div style="font-size:13px">Dist: ${distMM} mm</div>`;
  }
}

function quitarPresencia(i){
  const card=document.getElementById(`card-${i+1}`); 
  if(!card) return; 
  card.classList.remove('alert');
  const box=document.getElementById(`pres-${i+1}`); 
  if(box) box.innerHTML='';
}

/* --- Inicializa cards --- */
for(let i=0;i<NUM;i++) createCard(i);
updateSummary();

/* --- FIREBASE --- */
const firebaseConfig={ databaseURL:"https://enlace-t-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

db.ref("prueba").on("value", snap => {
  const data = snap.val();
  for(let i=0;i<NUM;i++){
    if(!active[i]) continue;
    const s = data ?? {};
    const t = Number(s.Temperatura_C ?? 0);
    const h = Number(s.Humedad_pct ?? 0);
    const d = Number(s.Distancia_mm ?? 0);

    lastValues[i] = {t,h,dist:d};

    document.getElementById(`tempVal-${i+1}`).textContent = `${t} °C`;
    document.getElementById(`humVal-${i+1}`).textContent = `${h} %`;

    // distancia limpia en mm
    const distMM = Math.round(d);
    document.getElementById(`dist-${i+1}`).textContent = `${distMM} mm`;

    if(chartsT[i]){
      chartsT[i].data.datasets[0].data[0] = t;
      chartsT[i].data.datasets[0].backgroundColor[0] = tempColor(t);
      chartsT[i].update();
    }
    if(chartsH[i]){
      chartsH[i].data.datasets[0].data[0] = h;
      chartsH[i].data.datasets[0].backgroundColor[0] = humColor();
      chartsH[i].update();
    }

    applyDistanceAlert(i,d);
  }

  updateSummary();
});

/* --- Historial semanal/mensual (ejemplo: filtrado manual) --- */
document.getElementById('histWeek').addEventListener('click',()=>{ alert('Función historial semanal activa'); });
document.getElementById('histMonth').addEventListener('click',()=>{ alert('Función historial mensual activa'); });

/* --- Modo claro/oscuro --- */
document.getElementById('modeToggle').addEventListener('click',()=>document.body.classList.toggle('light'));
</script>
</body>
</html>
